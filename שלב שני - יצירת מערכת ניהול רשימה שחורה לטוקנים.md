<div dir="rtl">

תרגיל: יצירת מערכת ניהול רשימה שחורה לטוקנים

# תרגיל: יצירת מערכת ניהול רשימה שחורה לטוקנים

## תוכן העניינים
1. [משימה](#משימה)
2. [מבנה התרגיל](#מבנה-התרגיל)
3. [שלב 1: יצירת TokenBlacklistService](#שלב-1-יצירת-tokenblacklistservice)
4. [שלב 2: עדכון RefreshTokenService](#שלב-2-עדכון-refreshtokenservice)
5. [שלב 3: עדכון מערכת ההתחברות](#שלב-3-עדכון-מערכת-ההתחברות)
6. [שלב 4: ניהול רענון טוקן](#שלב-4-ניהול-רענון-טוקן)
7. [שלב 5: עדכון SecurityConfig](#שלב-5-עדכון-securityconfig)
8. [שלב 6: עדכון JwtAuthenticationFilter](#שלב-6-עדכון-jwtauthenticationfilter)
9. [שלב 7: מימוש CustomLogoutHandler](#שלב-7-מימוש-customlogouthandler)
10. [שלב 8: ביצוע Logout ב-IntelliJ](#שלב-8-ביצוע-logout-ב-intellij)
11. [סיכום](#סיכום)

---

## משימה

במסגרת המשימה, תצטרכו להוסיף למערכת Spring Boot שלכם מנגנון **רשימה שחורה (Blacklist)** שימנע שימוש בטוקנים שפקעו תוקפם או בוטלו. בנוסף, תצטרכו לשפר את הטיפול בטוקנים וה-Refresh Tokens וליישם מנגנון לניהול, אחסון, והגבלת שימוש חוזר בהם.

---

## מבנה התרגיל

### שינויים והרחבות בקוד הקיים
- תיישמו `TokenBlacklistService` לשמירה וניהול הרשימה השחורה
- תרחיבו את הקוד כך שיוכל לטפל בטוקני גישה (JWT) וב-Refresh Tokens בצורה בטוחה, כולל אפשרות לביטול טוקנים במערכת ובלימת התקפות
- תוסיפו מנגנון לניהול **כתובות IP** כדי להוסיף שכבת אבטחה נוספת בעת שימוש ב-Refresh Tokens

---

## שלב 1: יצירת TokenBlacklistService

### דרישות המחלקה:
- תבנו מחלקה חדשה בשם `TokenBlacklistService` שתטפל בשמירת הטוקנים השחורים ותוודא שהטוקן לא יוכל לשמש שנית אם פקע תוקפו או בוטל

### ⚠️ הערה חשובה:
בתהליך ה-logout נשלח רק ה-Access Token, ואותו יש להכניס לרשימה השחורה, אבל לא נשלח ה-Refresh Token, וזיכרו שבשרת לא שומרים שום מידע קודם על הטוקנים.

**שאלה:** איך תדאגו לכך שגם ה-Refresh Token "יהיה ברשימה השחורה"?

### דרישות נוספות:
- המחלקה צריכה להיות "חכמה" כך שבכל תהליך בדיקה של טוקן, היא תסרוק את רשימת הטוקנים ותמחק מהרשימה טוקנים שפג תוקפם
    - **למה זה חשוב?** כדי למנוע ניפוח הזיכרון ולשמור על ביצועים טובים
- **שאלה לחשיבה:** באיזה מבנה נתונים תשתמשו לצורך הרשימה השחורה?
- **התייחסות ל-Concurrent Access:** שימו לב שהגישה לרשימה יכולה להתבצע ממספר חיבורים (Sessions), יש כאן בעיית Concurrent Access

---

## שלב 2: עדכון RefreshTokenService

תעדכנו את השירות שאחראי לניהול ה-Refresh Tokens כדי:

1. **לבדוק אם הטוקן שייך לרשימה השחורה**
2. **להוסיף את הטוקן לרשימה השחורה** במקרה של ריענון או יצירת טוקן חדש
3. **הוספת בדיקת IP:** שימו לב שיש להוסיף גם כאן את כתובת ה-IP של המשתמש

---

## שלב 3: עדכון מערכת ההתחברות (AuthenticationService)

תעדכנו את שירות ההתחברות כדי:

1. **ליצור Refresh Token** עבור כל משתמש שנכנס למערכת (כבר אמור להיות קיים במערכת) 
2. **לשמור את כתובת ה-IP** של המשתמש בעת יצירת ה-Refresh Token

---

## שלב 4: ניהול רענון טוקן

- תוסיפו **בדיקת IP** כדי לוודא שהבקשה לריענון מגיעה מאותה כתובת IP

---

## שלב 5: עדכון SecurityConfig

### הוספת מנגנון Logout

נבצע עדכונים ב-SecurityConfig כדי לתמוך בתהליך ה-Logout. הנה השינויים שיש לבצע:

</div>

```java
// הוספת מנגנון ה-Logout
.logout(logout -> logout
        .logoutUrl("/logout")
        .logoutSuccessHandler(customLogoutHandler) // מחלקת לוגאוט מותאמת אישית
        .invalidateHttpSession(true) // איבוד תקפות של הסשן
        .clearAuthentication(true)
        .permitAll());
```

<div dir="rtl">

---

## שלב 6: עדכון JwtAuthenticationFilter

### הוספת בדיקה ל-Blacklist
עדכון מסנן האימות כך שיבדוק האם הטוקן קיים ברשימה השחורה, ויחסום את הגישה אם כן.

### עדכון SecurityConfig לשימוש במסנן המעודכן

</div>

```java
private final TokenBlacklistService tokenBlacklistService;
// ...

.addFilterBefore(new JwtAuthenticationFilter(jwtUtil, userDetailsService, tokenBlacklistService),
                UsernamePasswordAuthenticationFilter.class)
```

<div dir="rtl">

---

## שלב 7: מימוש CustomLogoutHandler

יש ליצור מחלקה שתטפל בתהליך ה-Logout. המחלקה תוודא שהטוקן יהיה ברשימה השחורה ותבטל את ה-Refresh Token.

</div>

```java
@Component
@RequiredArgsConstructor
public class CustomLogoutHandler implements LogoutSuccessHandler {
    // ... המימוש כאן
}
```

<div dir="rtl">

---

## שלב 8: ביצוע Logout ב-IntelliJ

ניתן לבצע את תהליך ה-Logout דרך IntelliJ באמצעות HTTP Client מובנה של IntelliJ.

---

## סיכום

השלימו את כל השינויים הנדרשים תוך כדי בדיקת הפעולות הנכונות בכל שלב.

### בדיקה סופית:
בסוף, יש לבדוק את המערכת על ידי:
- כניסה למערכת
- ריענון טוקן
- התחברות מחדש
- ביצוע logout

כדי לוודא שהשינויים אכן עובדים כראוי.

### נקודות מפתח לזכור:
1. **בעיית ה-Refresh Token:** איך לטפל בטוקן שלא נשלח ב-logout?
2. **Concurrent Access:** שימוש במבנה נתונים מתאים
3. **ניקוי אוטומטי:** מחיקת טוקנים שפג תוקפם
4. **אבטחת IP:** בדיקת כתובת IP בריענון טוקנים
5. **ביצועים:** שמירה על רשימה שחורה יעילה

---

### 📝 הערות נוספות:
- שימו לב לטיפול בחריגות בכל השלבים
- ודאו שהלוגים מתועדים כראוי לצורכי דיבוג
- בחנו את המערכת במקרי קצה שונים

</div>